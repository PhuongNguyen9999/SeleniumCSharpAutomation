trigger:
- master
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

steps:
- script: dotnet build --configuration $(buildConfiguration)
  displayName: 'Build project'

# Run each scenario test class separately so pipeline logs show step-by-step results
- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario1_BookmarkTests" --logger "trx;LogFileName=Scenario1_BookmarkTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 1 - Bookmark Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario2_ProfileTests" --logger "trx;LogFileName=Scenario2_ProfileTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 2 - Profile Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario3_CollectionTests" --logger "trx;LogFileName=Scenario3_CollectionTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 3 - Collection Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario4_PhotoRemovalTests" --logger "trx;LogFileName=Scenario4_PhotoRemovalTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 4 - Photo Removal Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario5_DownloadTests" --logger "trx;LogFileName=Scenario5_DownloadTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 5 - Download Tests'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    searchFolder: '$(Build.ArtifactStagingDirectory)/test-results'
  condition: succeededOrFailed()

- powershell: |
    $resultsDir = "$(Build.ArtifactStagingDirectory)\test-results"
    $outDir = "$(Build.ArtifactStagingDirectory)\TestReports"
    Write-Host "Results dir: $resultsDir"
    if (-Not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }

    if (-Not (Test-Path $resultsDir)) {
      Write-Host "No test-results directory found. Creating empty index.html"
      $html = "<html><head><meta charset='utf-8'><title>Test Report</title></head><body><h1>No test results found</h1></body></html>"
      $html | Out-File -FilePath (Join-Path $outDir 'index.html') -Encoding UTF8
      exit 0
    }

    $trxFiles = Get-ChildItem -Path $resultsDir -Filter '*.trx' -Recurse | Sort-Object LastWriteTime
    $allTests = @()

    foreach ($f in $trxFiles) {
      try {
        [xml]$doc = Get-Content $f.FullName
      } catch {
        Write-Host "Failed to parse $($f.FullName): $_"
        continue
      }

      $runName = $doc.TestRun.Name
      if (-not $runName) { $runName = $f.BaseName }

      $unitResults = $doc.TestRun.Results.UnitTestResult
      if ($null -eq $unitResults) { $unitResults = @() }

      foreach ($r in $unitResults) {
        $output = $r.Output.StdOut
        $steps = @()
        
        if ($output) {
          $lines = $output -split "`n"
          foreach ($line in $lines) {
            $trimmed = $line.Trim()
            if ($trimmed -and -not $trimmed.StartsWith("at ")) {
              $steps += $trimmed
            }
          }
        }

        $allTests += [PSCustomObject]@{
          TestName = $r.testName
          Outcome = $r.outcome
          Duration = $r.duration
          Steps = $steps
          File = $f.Name
          Run = $runName
          StartTime = $r.startTime
          EndTime = $r.endTime
        }
      }

      Copy-Item -Path $f.FullName -Destination $outDir -Force
    }

    $totalTests = $allTests.Count
    $passedTests = ($allTests | Where-Object { $_.Outcome -eq 'Passed' }).Count
    $failedTests = ($allTests | Where-Object { $_.Outcome -eq 'Failed' }).Count
    $skippedTests = ($allTests | Where-Object { $_.Outcome -eq 'NotExecuted' -or $_.Outcome -eq 'Skipped' }).Count

    $htmlFile = Join-Path $outDir 'index.html'
    $sw = New-Object System.IO.StreamWriter($htmlFile, $false, [System.Text.Encoding]::UTF8)

    $sw.WriteLine('<!DOCTYPE html>')
    $sw.WriteLine('<html><head><meta charset="utf-8"><title>Test Report</title>')
    $sw.WriteLine('<style>')
    $sw.WriteLine('* { margin: 0; padding: 0; box-sizing: border-box; }')
    $sw.WriteLine('body { font-family: Segoe UI, Arial; background: #f5f5f5; padding: 20px; }')
    $sw.WriteLine('.container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }')
    $sw.WriteLine('h1 { color: #333; margin-bottom: 20px; border-bottom: 3px solid #0078d4; padding-bottom: 10px; }')
    $sw.WriteLine('h2 { color: #0078d4; margin-top: 30px; margin-bottom: 15px; }')
    $sw.WriteLine('.summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }')
    $sw.WriteLine('.summary-card { padding: 20px; border-radius: 8px; color: white; text-align: center; }')
    $sw.WriteLine('.summary-card.total { background: #0078d4; }')
    $sw.WriteLine('.summary-card.passed { background: #107c10; }')
    $sw.WriteLine('.summary-card.failed { background: #da3b01; }')
    $sw.WriteLine('.summary-card.skipped { background: #ffb900; }')
    $sw.WriteLine('.summary-card .number { font-size: 32px; font-weight: bold; }')
    $sw.WriteLine('.test-item { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }')
    $sw.WriteLine('.test-header { padding: 15px; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }')
    $sw.WriteLine('.test-outcome { padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; }')
    $sw.WriteLine('.outcome-passed { background: #d4edda; color: #155724; }')
    $sw.WriteLine('.outcome-failed { background: #f8d7da; color: #721c24; }')
    $sw.WriteLine('.test-details { padding: 15px; display: none; }')
    $sw.WriteLine('.test-details.show { display: block; }')
    $sw.WriteLine('.step-item { padding: 10px; margin: 8px 0; background: #f5f5f5; border-left: 3px solid #0078d4; }')
    $sw.WriteLine('</style></head><body>')
    $sw.WriteLine('<div class="container">')
    $sw.WriteLine('<h1>Test Execution Report</h1>')
    $sw.WriteLine('<div class="summary">')
    $sw.WriteLine("<div class='summary-card total'><div class='number'>$totalTests</div><div>Total</div></div>")
    $sw.WriteLine("<div class='summary-card passed'><div class='number'>$passedTests</div><div>Passed</div></div>")
    $sw.WriteLine("<div class='summary-card failed'><div class='number'>$failedTests</div><div>Failed</div></div>")
    $sw.WriteLine("<div class='summary-card skipped'><div class='number'>$skippedTests</div><div>Skipped</div></div>")
    $sw.WriteLine('</div><h2>Test Results</h2>')

    foreach ($test in $allTests | Sort-Object { $_.Outcome -ne 'Passed' }, TestName) {
      $outcomeClass = if ($test.Outcome -eq 'Passed') { 'outcome-passed' } elseif ($test.Outcome -eq 'Failed') { 'outcome-failed' } else { 'outcome-passed' }
      $testId = [System.Guid]::NewGuid().ToString()
      
      $sw.WriteLine("<div class='test-item'>")
      $sw.WriteLine("<div class='test-header' onclick=\"document.getElementById('$testId').classList.toggle('show')\">")
      $sw.WriteLine("<span>$($test.TestName)</span>")
      $sw.WriteLine("<span style='color:#666;font-size:12px'>$($test.Duration)</span>")
      $sw.WriteLine("<span class='test-outcome $outcomeClass'>$($test.Outcome)</span>")
      $sw.WriteLine('</div>')
      $sw.WriteLine("<div class='test-details' id='$testId'>")
      $sw.WriteLine("<div style='font-size:12px;color:#666'>File: <b>$($test.File)</b> | Run: <b>$($test.Run)</b></div>")
      
      if ($test.Steps.Count -gt 0) {
        foreach ($step in $test.Steps) {
          $step = $step -replace '<', '&lt;' -replace '>', '&gt;' -replace '"', '&quot;'
          $sw.WriteLine("<div class='step-item'>$step</div>")
        }
      } else {
        $sw.WriteLine("<div style='color:#999'>No step details available</div>")
      }
      
      $sw.WriteLine('</div></div>')
    }

    $sw.WriteLine('</div></body></html>')
    $sw.Close()
    
    Write-Host "HTML report generated successfully at $htmlFile"
  displayName: 'Generate Detailed HTML Test Report'
  condition: succeededOrFailed()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/TestReports'
    ArtifactName: 'TestReports'
    publishLocation: 'Container'
  condition: succeededOrFailed()
