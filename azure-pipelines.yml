trigger:
- master
- main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

steps:
- script: dotnet build --configuration $(buildConfiguration)
  displayName: 'Build project'

# Run each scenario test class separately so pipeline logs show step-by-step results
- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario1_BookmarkTests" --logger "trx;LogFileName=Scenario1_BookmarkTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 1 - Bookmark Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario2_ProfileTests" --logger "trx;LogFileName=Scenario2_ProfileTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 2 - Profile Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario3_CollectionTests" --logger "trx;LogFileName=Scenario3_CollectionTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 3 - Collection Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario4_PhotoRemovalTests" --logger "trx;LogFileName=Scenario4_PhotoRemovalTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 4 - Photo Removal Tests'

- script: dotnet test --configuration $(buildConfiguration) --filter "FullyQualifiedName~Scenario5_DownloadTests" --logger "trx;LogFileName=Scenario5_DownloadTests.trx" --results-directory $(Build.ArtifactStagingDirectory)/test-results
  displayName: 'Run Scenario 5 - Download Tests'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    searchFolder: '$(Build.ArtifactStagingDirectory)/test-results'
  condition: succeededOrFailed()

# Create a simple single-file HTML summary (index.html) from TRX files and publish it
- powershell: |
    $resultsDir = "$(Build.ArtifactStagingDirectory)\test-results"
    $outDir = "$(Build.ArtifactStagingDirectory)\TestReports"
    Write-Host "Results dir: $resultsDir"
    if (-Not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }

    if (-Not (Test-Path $resultsDir)) {
      Write-Host "No test-results directory found. Creating empty index.html"
      $html = "<html><head><meta charset='utf-8'><title>Test Report</title></head><body><h1>No test results found</h1></body></html>"
      $html | Out-File -FilePath (Join-Path $outDir 'index.html') -Encoding UTF8
      exit 0
    }

    $trxFiles = Get-ChildItem -Path $resultsDir -Filter '*.trx' -Recurse | Sort-Object LastWriteTime
    $summary = @()

    foreach ($f in $trxFiles) {
      try {
        [xml]$doc = Get-Content $f.FullName
      } catch {
        Write-Host "Failed to parse $($f.FullName): $_"
        continue
      }

      $runName = $doc.TestRun.Name
      if (-not $runName) { $runName = $f.BaseName }

      $results = @()
      $unitResults = $doc.TestRun.Results.UnitTestResult
      if ($null -eq $unitResults) { $unitResults = @() }

      foreach ($r in $unitResults) {
        $results += [PSCustomObject]@{
          TestName = $r.testName
          Outcome = $r.outcome
          Duration = $r.duration
        }
      }

      $summary += [PSCustomObject]@{
        File = $f.Name
        Run = $runName
        Passed = ($results | Where-Object { $_.Outcome -eq 'Passed' }).Count
        Failed = ($results | Where-Object { $_.Outcome -eq 'Failed' }).Count
        Skipped = ($results | Where-Object { $_.Outcome -eq 'NotExecuted' -or $_.Outcome -eq 'Skipped' }).Count
        Total = $results.Count
        Details = $results
      }

      # Copy TRX to reports folder for reference
      Copy-Item -Path $f.FullName -Destination $outDir -Force
    }

    # Build HTML
    $html = "<html><head><meta charset='utf-8'><title>Test Report</title>
    <style>body{font-family:Segoe UI,Arial;margin:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:8px}th{background:#f4f4f4}</style>
    </head><body>
    <h1>Test Report</h1>
    <h2>Summary</h2>
    <table>
      <tr><th>Run</th><th>File</th><th>Total</th><th>Passed</th><th>Failed</th><th>Skipped</th></tr>"

    foreach ($s in $summary) {
      $html += "<tr><td>$($s.Run)</td><td><a href='$($s.File)'>$($s.File)</a></td><td>$($s.Total)</td><td>$($s.Passed)</td><td style='color:red'>$($s.Failed)</td><td>$($s.Skipped)</td></tr>"
    }

    $html += "</table><hr/>"

    foreach ($s in $summary) {
      $html += "<h3>Details: $($s.Run) ($($s.File))</h3>"
      $html += "<table><tr><th>Test</th><th>Outcome</th><th>Duration</th></tr>"
      foreach ($d in $s.Details) {
        $color = if ($d.Outcome -eq 'Passed') { 'green' } elseif ($d.Outcome -eq 'Failed') { 'red' } else { 'gray' }
        $html += "<tr><td>$($d.TestName)</td><td style='color:$color'>$($d.Outcome)</td><td>$($d.Duration)</td></tr>"
      }
      $html += "</table>"
    }

    $html += "</body></html>"

    $html | Out-File -FilePath (Join-Path $outDir 'index.html') -Encoding UTF8
  displayName: 'Generate Simple Index HTML Test Report'
  condition: succeededOrFailed()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/TestReports'
    ArtifactName: 'TestReports'
    publishLocation: 'Container'
  condition: succeededOrFailed()
